/*!
 * name: @feizheng/sso-baidu-pan
 * description: Sso for baidu pan.
 * url: https://github.com/afeiship/sso-baidu-pan
 * version: 1.0.5
 * date: 2020-03-18 23:45:55
 * license: MIT
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _puppeteer=_interopRequireDefault(require("puppeteer")),_ssoQqPtlogin=_interopRequireDefault(require("@feizheng/sso-qq-ptlogin2")),_nextNodeCookie=_interopRequireDefault(require("@feizheng/next-node-cookie"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,n,t,r,o,a,u){try{var i=e[a](u),s=i.value}catch(e){return void t(e)}i.done?n(s):Promise.resolve(s).then(r,o)}function _asyncToGenerator(i){return function(){var e=this,u=arguments;return new Promise(function(n,t){var r=i.apply(e,u);function o(e){asyncGeneratorStep(r,n,t,o,a,"next",e)}function a(e){asyncGeneratorStep(r,n,t,o,a,"throw",e)}o(void 0)})}}var TOKEN_RE=/"bdstoken":"(.*?)"/,DEFAULT_OPTIONS={username:null,password:null,headless:!0,stringify:!1,args:["--no-sandbox"]},_default=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(i){var s,c,l,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=Object.assign({},DEFAULT_OPTIONS,i),c={timeout:0,waitUntil:"domcontentloaded"},e.next=4,_puppeteer.default.launch(s);case 4:return l=e.sent,e.next=7,l.newPage();case 7:return p=e.sent,console.log("new page...!"),e.next=11,p.goto("https://pan.baidu.com/");case 11:return console.log("goto pan.baidu. click qq login!"),e.next=14,p.waitForSelector(".bd-acc-qzone");case 14:return e.next=16,p.click(".bd-acc-qzone .phoenix-btn-item");case 16:return console.log("click qq login!"),e.abrupt("return",new Promise(function(u){p.addListener("popup",function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ssoQqPtlogin.default)(n,i);case 2:return console.log("qq login pass!"),e.next=5,p.goto("https://pan.baidu.com/disk/home",c);case 5:return e.next=7,p.cookies();case 7:return t=e.sent,e.next=10,p.content();case 10:r=e.sent,o=r.match(TOKEN_RE),l.close(),a=s.stringify?_nextNodeCookie.default.stringify(t):t,u({cookies:a,bdstoken:o[1]});case 15:case"end":return e.stop()}},e)}));return function(e){return n.apply(this,arguments)}}())}));case 18:case"end":return e.stop()}},e)}));return function(e){return n.apply(this,arguments)}}();exports.default=_default;